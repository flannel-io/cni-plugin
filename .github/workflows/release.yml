on:
  release:
    types: [published]

env:
  GO_VERSION: "1.16.10"
  LINUX_ARCHES: "amd64 386 arm arm64 s390x mips64le ppc64le"
  REPOSITORY: flannelcni/flannel-cni-plugin

jobs:

  build-binaries:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        go: [ "1.16.10" ]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - uses: WillAbides/setup-go-faster@v1.7.0
        with:
          go-version: ${{ matrix.go }}

      - name: go mod vendor and tidy
        run: make vendor

      - name: build all
        run: make build_all

      - name: run tests
        run: make test_linux

      - name: run go vet
        run: go vet

      - uses: dominikh/staticcheck-action@v1.0.0
        with:
          version: "2021.1.2"
          install-go: false
          cache-key: ${{ matrix.go }}

  upload-binaries:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: build
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - uses: ncipollo/release-action@v1
          with:
            artifacts: "dist/flannel-*,release-${{ env.TAG }}/*.tar.gz"
            prerelease: true
            generateReleaseNotes: true
            commit: ${{ github.sha }}
            tag: ${{ github.ref_name }}
    #         bodyFile: "body.md"
    #         token: ${{ secrets.GITHUB_TOKEN }}
